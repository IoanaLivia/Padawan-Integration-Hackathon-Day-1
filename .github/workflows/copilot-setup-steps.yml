name: Padawan Integration Hackathon CI/CD

on:
  workflow_dispatch:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          flake8 src/ tests/ --max-line-length=100 --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run tests with pytest
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Test application execution
        run: |
          python src/main.py

  lint-and-style:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Comprehensive linting
        run: |
          flake8 src/ tests/ --max-line-length=100 --statistics

  copilot-setup-steps:
    runs-on: ubuntu-latest
    needs: [test, lint-and-style]
    if: github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read
    environment: copilot
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Run Copilot integration setup
        run: |
          echo "Running Copilot integration setup steps..."
          echo "Environment: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
 
